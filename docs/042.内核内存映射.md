# 内核内存映射

本小结将前8M的物理内存映射到虚拟内存中，且物理内存和虚拟内存的地址相同

第一个页表的最后一个页表项指向页目录表的物理地址，方便之后修改页目录表


## 刷新快表

为了防止CPU使用旧的页表，需要刷新快表，快表（Translation Lookaside Buffer，TLB）中的内容会在以下情况下被修改：

- 当CPU访问内存时，如果在快表中找不到相应的页表项，则会访问内存中的页表，检索物理地址，并将相应的页表项添加到快表中。

- 当快表已满且需要注册新页面时，操作系统会使用淘汰策略从快表中淘汰一个项，以便为新的页表项腾出空间。

- 当操作系统更改页表中的条目时，它可以使用`invlpg`指令来确保处理器不会使用过时的TLB条目来访问内存。

- 更新cr3寄存器时，会刷新快表

- `mov cr3, eax`
- `invlpg`

```c++
// 刷新虚拟地址 vaddr 的 快表 TLB
static void flush_tlb(u32 vaddr)
{
    asm volatile("invlpg (%0)" ::"r"(vaddr)
                 : "memory");
}
```

