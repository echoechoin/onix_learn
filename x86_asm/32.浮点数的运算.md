# 基础浮点运算

## FPU Floating Point Unit

早期FPU是一个独立的硬件单元，用于浮点运算。

- 8086 / 8087
- 80286 / 80287
- 80386 / 80387 最早的linux使用整数运算模拟浮点运算

到了80486，FPU被集成到CPU中，成为CPU的一部分，FPU的寄存器和CPU的寄存器是共享的，可以直接访问，不需要通过FPU指令。

## 寄存器

- 8个80位（扩展精度）的数据寄存器：ST0 ~ ST7
  - 形成循环堆栈
  - 栈顶是ST0
- 3个16位的控制寄存器
  - 控制 fcntl
  - 状态 fstat
  - 标记 ftag

## 状态寄存器

状态位 | 说明
---   |---
0     | 非法操作异常标志
1     | 非规格化操作异常标志
2     | 除零异常标志
3     | 溢出异常标志
4     | 下溢异常标志
5     | 精度异常标志
6     | 堆栈错误
7     | 错误汇总状态
8     | 条件码0 C0
9     | 条件码1 C1
10    | 条件码2 C2
11-13 | 堆栈顶部指针
14    | 条件代码位3 C3
15    | FPU忙标志

操作状态寄存器的指令`fstsw`（store status word），将状态寄存器的低16位存入内存。

## 控制寄存器

控制位 | 说明
---   |---
0     | 非法操作异常控制
1     | 非规格化操作异常控制
2     | 除零异常控制
3     | 溢出异常控制
4     | 下溢异常控制
5     | 精度异常控制
6-7   | 保留
8-9   | 精度控制
10-11 | 舍入控制
12    | 无穷大控制
13-15 | 保留

精度控制

- 00 单精度
- 01 保留
- 10 双精度
- 11 扩展精度（默认）

舍入控制

- 00 舍入到最近（默认）
- 01 向下舍入（向负无穷）
- 10 向上舍入（向正无穷）
- 11 舍入到零

操作控制寄存器的指令`fstcw`（存储）`fldcw`（加载）

## 标记寄存器

最低两位：

- 00 合法的扩展双进度值
- 01 零值
- 10 特殊的浮点数
- 11 无内容

## 浮点运算指令

指令  | 说明
---   | ---
fadd  | 加法
fsub  | 减法
fmul  | 乘法
fdiv  | 除法
fdivr | 反除法
fsubr | 反减法

```s
fadd source    # ST0 = ST0 + source
fadd st0, stx  # ST0 = ST0 + STx
fadd stx, st0  # STx = STx + ST0
faddp stx, st0 # STx = STx + ST0, pop ST0
faddp          # St1 = ST1 + ST0, pop ST0
fiadd source   # ST0 = ST0 + source
```