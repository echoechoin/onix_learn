# 外中断和时钟

CPU需要通知硬件做某事的时候，需要通过端口指明。硬件需要通知CPU做某事的时候，需要通过中断来通知。

时钟信号 / 脉冲 - CPU的脉搏 <----> 时钟中断 - OS的脉搏

## 8086的中断

- NMI Non-Maskable Interrupt 不可屏蔽中断
- INTR Interrupt 可屏蔽中断

不可屏蔽中断是无法处理的（内存错误、掉电等）。可屏蔽中断可以处理，由我们自己实现处理函数

8259 可编程中断控制器 / PIC Programmable Interrupt Controller

8259一个芯片支持八个中断，8086只有一根中断线，因此两个芯片级联，可以支持16个中断。

```
CPU---+
      |
      +-NMI（软件无法处理）
      +-INTR-+
             |
             +-时钟
             +-键盘
             +-软盘
             +-从芯片-+
                     |
                     +-实时时钟
                     +-硬盘
                     +-鼠标
```

## 8086中断向量表

向量       | 功能
----------|---
0x00      | 除0
0x01      | 单步调试
0x02      | NMI
0x03      | 断点
0x04      | 溢出
0x05      | 越界
0x06-0x07 | 保留
0x08      | 时钟
0x09      | 键盘
0x0a      | 保留
0x0b      | COM2
0x0c      | COM1
0x0d      | 保留
0x0e      | 软盘
0x0f      | 打印机

## 操作8259芯片

端口 |  说明         | 标记
---- | ------------ | ----
0x20 | 主芯片命令端口 | PIC_M_CMD
0x21 | 主芯片数据端口 | PIC_M_DATA
0x40 | 从芯片命令端口 | PIC_S_CMD
0x41 | 从芯片数据端口 | PIC_S_DATA

- ICW1 ~ ICW4用于初始化8259 （Initial Command Word）
- OCW1 ~ OCW3用于操作8259 （Operation Command Word）


本实验不使用ICW，使用其默认的值即可。

三个开关：

```asm
; 1. 向OCW1写入屏蔽字，打开时钟中断
; 2. sti指令设置CPU允许外中断
; 3. 向OCW2写入0x20，表示通知8259中断处理完毕
```

## 进入中断处理函数后，flag中的中断允许位会被清0

为了防止中断中再次发生中断。flag中的中断允许位为0的时候，CPU不会响应中断。