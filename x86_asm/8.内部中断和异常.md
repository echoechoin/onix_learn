# 内部中断和异常

## 中断

起始地址 | 结束地址 | 大小 | 用途
------- | ------  | ---- | ---
`0x000`  | `0x3ff`   | 1KB     | 中断向量表
`0x400`  | `0x4ff`   | 256B    | BIOS数据区
`0x500`  | `0x7bff`  | 29.71KB | `可用区域`
`0x7c00` | `0x7dff`  | 512B    | `MBR 加载区域`
`0x7e00` | `0x9fbff` | 607.6KB | `可用区域`
`0x9fc00`| `0x9ffff` | 1KB     | 扩展BIOS数据区
`0xa0000`| `0xaffff` | 64KB    | 用于彩色显示适配器
`0xb0000`| `0xb7fff` | 32KB    | 用于黑白显示适配器
`0xb8000`| `0xbffff` | 32KB    | 用于文本显示适配器
`0xc0000`| `0xc7fff` | 32KB    | 显示适配器BIOS
`0xc8000`| `0xeffff` | 160KB   | 映射内存
`0xf0000`| `0xfffff` | 64KB-16B| 系统BIOS
`0xffff0`| `0xfffff` | 16B     | 系统BIOS 入口地址

我们需要操作中断向量表，0x0000 ~ 0x3fff -> 0x400B。一个中断向量占用4字节，0x400 / 4 = 0x100（256）个中断向量。

### 常用中断向量

中断号 | 中断向量地址 | 中断向量内容 | 用途
------|--------------|--------------|----
0x00  | 0x0000       | 0x0000       | 除0异常
0x80  | 0x0200       | 0x0000       | 系统调用

### 注册中断函数

```asm
; 注册中断服务程序
mov word [0x80 * 4], print ; 函数地址
mov word [0x80 * 4 + 2], cs ; 段地址
```

需要注意的是，中断函数会将ip, cs 和 flags 压栈，所以中断函数的返回指令是 `iret`而不是 `ret`。

### 触发中断

```asm
int 0x80
```

## 异常

除零异常会触发中断向量表中的0x00号中断向量，所以我们需要在0x00号中断向量中注册除零异常的处理函数。其实和中断差不多。。

> 注意：异常调用中断函数并返回后，会再次触发异常。因此，触发异常后应该结束程序。


